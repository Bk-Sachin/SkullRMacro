<Window x:Class="SkullRMacro.MacroEditor"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SkullRMacro"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="Macro editor" Height="600" Width="1100" Foreground="White">

    <Window.Resources>
        <!-- Copied Resources -->
        <SolidColorBrush x:Key="PrimaryBackgroundColor" Color="#FF1A1A1A"/>
        <SolidColorBrush x:Key="SecondaryBackgroundColor" Color="#FF252525"/>
        <SolidColorBrush x:Key="TertiaryBackgroundColor" Color="#FF333333"/>
        <SolidColorBrush x:Key="AccentColorBrush" Color="Red"/>
        <SolidColorBrush x:Key="BorderColorBrush" Color="#FF555555"/>
        <SolidColorBrush x:Key="TextPrimaryColorBrush" Color="White"/>
        <SolidColorBrush x:Key="TextSecondaryColorBrush" Color="LightGray"/>
        <SolidColorBrush x:Key="TextDisabledColorBrush" Color="Gray"/>
        <SolidColorBrush x:Key="ButtonPressedBackgroundBrush" Color="#FF4F0000"/>
        <SolidColorBrush x:Key="ButtonHoverBackgroundBrush" Color="#44FF0000"/>
        <SolidColorBrush x:Key="MouseLMBColor" Color="#FF00BFFF"/>
        <SolidColorBrush x:Key="MouseRMBColor" Color="#FF191970"/>
        <SolidColorBrush x:Key="MouseScrollClickColor" Color="#FF7FFF00"/>
        <SolidColorBrush x:Key="MouseScrollUpColor" Color="#FFFFFF00"/>
        <SolidColorBrush x:Key="MouseScrollDownColor" Color="#FFFF8C00"/>

        <sys:Double x:Key="FontSizeSmall">10</sys:Double>
        <sys:Double x:Key="FontSizeNormal">12</sys:Double>
        <sys:Double x:Key="FontSizeTiny">8</sys:Double>
        <!-- For smaller key text -->

        <Style TargetType="Button" x:Key="BaseButtonStyle">
            <Setter Property="Background" Value="{StaticResource SecondaryBackgroundColor}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryColorBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource AccentColorBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource ButtonHoverBackgroundBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource ButtonPressedBackgroundBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryColorBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Opacity" Value="0.6"/>
                                <Setter Property="Foreground" Value="{StaticResource TextDisabledColorBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Button" x:Key="KeyboardButtonStyle" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="MinWidth" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="FontSize" Value="{StaticResource FontSizeNormal}"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Margin" Value="1.5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColorBrush}"/>
            <Setter Property="Width" Value="36"/>
            <Setter Property="MinHeight" Value="0"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="2">
                            <!-- Ensure TextBlock fits -->
                            <Viewbox MaxHeight="20" MaxWidth="30">
                                <TextBlock Text="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{TemplateBinding Foreground}" FontSize="{TemplateBinding FontSize}"/>
                            </Viewbox>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentColorBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource AccentColorBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource ButtonPressedBackgroundBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="Red"/>
                            </Trigger>
                            <!-- Example DataTrigger for key 'C' -->
                            <DataTrigger Binding="{Binding Content, RelativeSource={RelativeSource Self}}" Value="C">
                                <Setter TargetName="border" Property="BorderBrush" Value="Red"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="2"/>
                                <Setter Property="Foreground" Value="Red"/>
                            </DataTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Button" x:Key="SpacebarStyle" BasedOn="{StaticResource KeyboardButtonStyle}">
            <Setter Property="Width" Value="Auto"/>
            <!-- Allow stretching -->
            <Setter Property="MinWidth" Value="180"/>
            <!-- Give it a reasonable minimum -->
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
        </Style>

        <Style TargetType="Button" x:Key="SmallIconButton" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="MinWidth" Value="30"/>
            <Setter Property="Height" Value="30"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColorBrush}"/>
        </Style>

        <PathGeometry x:Key="LMB_OverlayShape" Figures="M15,100 L15,30 C15,15 30,15 45,15 L65,15 L65,100 Z"/>
        <PathGeometry x:Key="RMB_OverlayShape" Figures="M75,15 L95,15 C110,15 125,15 125,30 L125,100 L75,100 Z"/>
        <PathGeometry x:Key="ScrollClick_OverlayShape" Figures="M66,40 h8 v20 h-8 Z"/>
        <PathGeometry x:Key="ScrollUpChevrons" Figures="M67,35 L70,30 L73,35 M67,28 L70,23 L73,28"/>
        <PathGeometry x:Key="ScrollDownChevrons" Figures="M67,65 L70,70 L73,65 M67,72 L70,77 L73,72"/>

        <Style TargetType="Button" x:Key="StandardMouseButtonStyle" BasedOn="{StaticResource SmallIconButton}">
            <Setter Property="Margin" Value="0"/>
            <Setter Property="MinWidth" Value="0"/>
            <Setter Property="MinHeight" Value="0"/>
            <Setter Property="Height" Value="Auto"/>
            <Setter Property="Width" Value="Auto"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="VerticalAlignment" Value="Stretch"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#44FFFFFF"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="Button" x:Key="ScrollIndicatorButtonStyle" BasedOn="{StaticResource SmallIconButton}">
            <Setter Property="Margin" Value="0"/>
            <Setter Property="MinWidth" Value="0"/>
            <Setter Property="MinHeight" Value="0"/>
            <Setter Property="Width" Value="Auto"/>
            <Setter Property="Height" Value="Auto"/>
            <Setter Property="FontSize" Value="{StaticResource FontSizeSmall}"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#44FFFFFF"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="Button" x:Key="SideMouseButtonSyle" BasedOn="{StaticResource StandardMouseButtonStyle}">
            <Setter Property="Background" Value="{StaticResource SecondaryBackgroundColor}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryColorBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColorBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <!-- NEW Style for Smaller Keyboard Buttons -->
        <Style TargetType="Button" x:Key="SmallKeyboardButtonStyle" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="Width" Value="28"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="MinWidth" Value="0"/>
            <Setter Property="MinHeight" Value="0"/>
            <Setter Property="FontSize" Value="{StaticResource FontSizeTiny}"/>
            <Setter Property="Padding" Value="1"/>
            <Setter Property="Margin" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColorBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="2">
                            <Viewbox MaxHeight="18" MaxWidth="24">
                                <TextBlock Text="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{TemplateBinding Foreground}" FontSize="{TemplateBinding FontSize}"/>
                            </Viewbox>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentColorBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource AccentColorBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource ButtonPressedBackgroundBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="Red"/>
                            </Trigger>
                            <!-- Add DataTriggers here if needed for specific key highlights -->
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Button" x:Key="SmallSpacebarStyle" BasedOn="{StaticResource SmallKeyboardButtonStyle}">
            <Setter Property="Width" Value="Auto"/>
            <Setter Property="MinWidth" Value="140"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
        </Style>

        <Style TargetType="TextBlock">
             <Setter Property="Foreground" Value="LightGray"/>
        </Style>
        <!-- Converter to invert boolean -->
        <local:InverseBooleanConverter x:Key="InverseBooleanConverter"/>

        <!-- ListView Selection Colors -->
        <SolidColorBrush x:Key="ListViewItemSelectedBackgroundBrush" Color="#FF550000"/> <!-- Dark Red -->
        <SolidColorBrush x:Key="ListViewItemFocusBorderBrush" Color="#FFFF4500"/> <!-- OrangeRed -->

        <!-- Style for ListViewItems -->
        <Style x:Key="MacroListViewItemStyle" TargetType="ListViewItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryColorBrush}"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="3"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent"/> <!-- Transparent by default -->
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}"
                                SnapsToDevicePixels="true">
                            <GridViewRowPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                  VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                  SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource ListViewItemSelectedBackgroundBrush}"/>
                    <Setter Property="Foreground" Value="White"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource AccentColorBrush}"/>
                </Trigger>
                <MultiTrigger>
                    <MultiTrigger.Conditions>
                        <Condition Property="IsSelected" Value="True"/>
                        <Condition Property="Selector.IsSelectionActive" Value="False"/>
                    </MultiTrigger.Conditions>
                    <Setter Property="Background" Value="#FF444444"/> <!-- Different background when focus is lost -->
                    <Setter Property="Foreground" Value="LightGray"/>
                </MultiTrigger>
                <!-- Trigger for Focus Visual -->
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource ListViewItemFocusBorderBrush}"/>
                    <Setter Property="BorderThickness" Value="1"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{StaticResource TextDisabledColorBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Window.Resources>

    <Grid Background="{StaticResource PrimaryBackgroundColor}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/> <!-- Left Macro List Area -->
            <ColumnDefinition Width="*"/> <!-- Center Content Area -->
            <ColumnDefinition Width="Auto"/> <!-- Right Toolbar -->
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Top Toolbar Row (Center) -->
            <RowDefinition Height="*"/> <!-- Main Content Row -->
            <RowDefinition Height="Auto"/> <!-- Bottom Row -->
        </Grid.RowDefinitions>

        <!-- Top Toolbar (Center Panel) -->
        <ToolBarTray Grid.Row="0" Grid.Column="1" Background="{StaticResource PrimaryBackgroundColor}">
            <ToolBar Background="{StaticResource PrimaryBackgroundColor}" Foreground="WhiteSmoke" Band="1" BandIndex="1">
                 <Button Foreground="WhiteSmoke" x:Name="UndoButton" Content="↩" ToolTip="Undo"/>
                 <Button Foreground="WhiteSmoke" x:Name="RedoButton" Content="↪" ToolTip="Redo"/>
                 <Button Foreground="WhiteSmoke" x:Name="SaveButton" Content="💾" ToolTip="Save" Click="SaveButton_Click"/>
                 <Separator/>
                 <Button Foreground="WhiteSmoke" x:Name="CutButton" Content="Cut" ToolTip="Cut"/>
                 <Button Foreground="WhiteSmoke" x:Name="CopyButton" Content="Copy" ToolTip="Copy"/>
                 <Button Foreground="WhiteSmoke" x:Name="PasteButton" Content="Paste" ToolTip="Paste"/>
                 <Separator/>
                 <Button Foreground="WhiteSmoke" x:Name="AddStepButton" Content="Add" ToolTip="Add Step"/>
                 <Button Foreground="WhiteSmoke" x:Name="EditStepButton" Content="Edit" ToolTip="Edit Step"/>
                 <Button Foreground="WhiteSmoke" x:Name="DeleteStepButton" Content="Delete" ToolTip="Delete Step"/>
                 <Separator/>
                 <Button Foreground="WhiteSmoke" x:Name="MoveUpButton" Content="↑" ToolTip="Move Up"/>
                 <Button Foreground="WhiteSmoke" x:Name="MoveDownButton" Content="↓" ToolTip="Move Down"/>
                 <Separator/>
                 <Button Foreground="WhiteSmoke" x:Name="RecordButton" Content="● Rec" ToolTip="Record Macro" Click="RecordButton_Click"/>
                 <Button Foreground="WhiteSmoke" x:Name="StopButton" Content="■ Stop" ToolTip="Stop Recording" Click="StopButton_Click"/>
                 <Separator/>
                 <Button Foreground="WhiteSmoke" x:Name="SearchButton" Content="🔍 Search" ToolTip="Search Steps"/>
            </ToolBar>
        </ToolBarTray>

        <!-- Placeholder for Macro List (Left Panel) -->
        <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0" Background="{StaticResource SecondaryBackgroundColor}" Margin="5" BorderBrush="{StaticResource BorderColorBrush}" BorderThickness="1" CornerRadius="3">
             <TextBlock Text="[Future Macro List Area (TreeView)]" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource TextDisabledColorBrush}"/>
        </Border>

        <!-- Center Content Area: Replaced TextBlock with ListView -->
         <Border Grid.Row="1" Grid.Column="1" Background="{StaticResource SecondaryBackgroundColor}" Margin="0,0,5,5" BorderBrush="{StaticResource BorderColorBrush}" BorderThickness="0,0,1,1">
             <!-- <TextBlock Text="[Macro Content Area]" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource TextDisabledColorBrush}"/> -->
             <ListView x:Name="eventTimeline" 
                       ItemsSource="{Binding MacroSteps}" 
                       Background="{StaticResource SecondaryBackgroundColor}"
                       BorderThickness="0"
                       Foreground="{StaticResource TextPrimaryColorBrush}"
                       ItemContainerStyle="{StaticResource MacroListViewItemStyle}">
                 <ListView.ContextMenu>
                     <ContextMenu>
                         <MenuItem Header="Add comment" Click="CommentButton_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="✎" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <Separator/>
                         <MenuItem Header="Offset all delays" Click="OffsetDelaysMenuItem_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="⏱" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <MenuItem Header="Offset all coordinates" Click="OffsetCoordinatesMenuItem_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="📍" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <Separator/>
                         <MenuItem Header="Copy" Click="CopyButton_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="📋" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <MenuItem Header="Cut" Click="CutButton_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="✂" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <Separator/>
                         <MenuItem Header="Move up" Click="MoveUpButton_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="↑" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <MenuItem Header="Move down" Click="MoveDownButton_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="↓" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <Separator/>
                         <MenuItem Header="Undo" Click="UndoButton_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="↩" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <MenuItem Header="Redo" Click="RedoButton_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="↪" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <Separator/>
                         <MenuItem Header="Remove all delays" Click="RemoveAllDelaysMenuItem_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="⌛" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <MenuItem Header="Delete" Click="DeleteStepButton_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="🗑" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                         <MenuItem Header="Clear all" Click="ClearAllMenuItem_Click">
                             <MenuItem.Icon>
                                 <TextBlock Text="🧹" FontSize="14"/>
                             </MenuItem.Icon>
                         </MenuItem>
                     </ContextMenu>
                 </ListView.ContextMenu>
                 <ListView.View>
                     <GridView AllowsColumnReorder="True">
                         <GridViewColumn Header="Step" Width="50" DisplayMemberBinding="{Binding StepNumber}"/>
                         <GridViewColumn Header="Action" Width="400" DisplayMemberBinding="{Binding ActionDescription}"/>
                         <GridViewColumn Header="Comment" Width="200" DisplayMemberBinding="{Binding Comment}"/>
                     </GridView>
                 </ListView.View>
             </ListView>
         </Border>

        <!-- Right Vertical Toolbar -->
        <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="2" Background="{StaticResource PrimaryBackgroundColor}" BorderBrush="{StaticResource BorderColorBrush}" BorderThickness="1,0,0,0" Padding="0,5,0,0">
             <StackPanel Orientation="Vertical" VerticalAlignment="Top" Margin="5">
                 <Button Foreground="WhiteSmoke" x:Name="TimeButton" Content="⏱️" ToolTip="Set Time/Delay" Style="{StaticResource SmallIconButton}" Margin="2" Click="TimeButton_Click"/>
                 <Button Foreground="WhiteSmoke" x:Name="RepeatButton" Content="🔁" ToolTip="Set Operation Mode" Style="{StaticResource SmallIconButton}" Margin="2" Click="RepeatButton_Click">
                     <Button.ContextMenu>
                         <ContextMenu>
                             <MenuItem Header="No repetitions" Tag="RunOnce" Click="PlaybackModeMenuItem_Click">
                                 <MenuItem.Icon>
                                     <TextBlock Text="🚫" FontSize="14"/>
                                 </MenuItem.Icon>
                             </MenuItem>
                             <MenuItem Header="Press to start, release to stop" Tag="HoldToRun" Click="PlaybackModeMenuItem_Click">
                                 <MenuItem.Icon>
                                     <TextBlock Text="⏯️" FontSize="14"/>
                                 </MenuItem.Icon>
                             </MenuItem>
                             <MenuItem Header="Press to start, press again to stop" Tag="ToggleRun" Click="PlaybackModeMenuItem_Click">
                                 <MenuItem.Icon>
                                     <TextBlock Text="🔄" FontSize="14"/>
                                 </MenuItem.Icon>
                             </MenuItem>
                         </ContextMenu>
                     </Button.ContextMenu>
                 </Button>
                 <Button Foreground="WhiteSmoke" x:Name="GotoLineButton" Content="⤵️" ToolTip="Go to Line" Style="{StaticResource SmallIconButton}" Margin="2" Click="GotoLineButton_Click"/>
                 <Button Foreground="WhiteSmoke" x:Name="AddLoopButton" Content="➿" ToolTip="Add Loop" Style="{StaticResource SmallIconButton}" Margin="2" Click="AddLoopButton_Click"/>
                 <Button Foreground="WhiteSmoke" x:Name="CommentButton" Content="💬" ToolTip="Add Comment" Style="{StaticResource SmallIconButton}" Margin="2" Click="CommentButton_Click"/>
                 <Button Foreground="WhiteSmoke" x:Name="ColorButton" Content="💧" ToolTip="Add Color Definition" Style="{StaticResource SmallIconButton}" Margin="2" Click="ColorButton_Click"/>
                 <Button Foreground="WhiteSmoke" x:Name="LangChangeButton" Content="A文" ToolTip="Add Keyboard Language Change" Style="{StaticResource SmallIconButton}" Margin="2" Click="LangChangeButton_Click"/>
                 <Button Foreground="WhiteSmoke" x:Name="SetVariableButton" Content="[=]" ToolTip="Set Variable" Style="{StaticResource SmallIconButton}" Margin="2" Click="SetVariableButton_Click"/>
             </StackPanel>
        </Border>

        <!-- NEW Bottom-Left Toolbar -->
        <StackPanel Grid.Row="2" Grid.Column="0" Orientation="Horizontal" Background="{StaticResource PrimaryBackgroundColor}" VerticalAlignment="Bottom" Margin="5,0,5,5">
             <Button x:Name="DeleteMacroButton" ToolTip="Delete file or folder" Style="{StaticResource SmallIconButton}" Content="🗑" Margin="2,0" Foreground="WhiteSmoke" Click="DeleteMacroButton_Click"/>
             <Button x:Name="AddMacroButton" ToolTip="Create file or folder" Style="{StaticResource SmallIconButton}" Content="➕" Margin="2,0" Foreground="WhiteSmoke" Click="AddMacroButton_Click"/>
             <Button x:Name="RenameMacroButton" ToolTip="Rename file or folder" Style="{StaticResource SmallIconButton}" Content="✎" Margin="2,0" Foreground="WhiteSmoke" Click="RenameMacroButton_Click"/>
             <Button x:Name="InfoMacroButton" ToolTip="File info" Style="{StaticResource SmallIconButton}" Content="ℹ" Margin="2,0" Foreground="WhiteSmoke" Click="InfoMacroButton_Click"/>
             <Button x:Name="SaveAsMacroButton" ToolTip="Save As" Style="{StaticResource SmallIconButton}" Content="💾⇩" Margin="2,0" Foreground="WhiteSmoke" Click="SaveAsMacroButton_Click"/>
             <Button x:Name="OpenMacroButton" ToolTip="Open file" Style="{StaticResource SmallIconButton}" Content="📂" Margin="2,0" Foreground="WhiteSmoke" Click="OpenMacroButton_Click"/>
        </StackPanel>

        <!-- Bottom Panel: Keyboard/Mouse + Buttons -->
        <Grid Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2"> <!-- Spans Center and Right columns -->
             <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Keyboard/Mouse Area -->
                <RowDefinition Height="Auto"/> <!-- Button Bar -->
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="{StaticResource SecondaryBackgroundColor}" Margin="0,0,5,5" Padding="5" BorderBrush="{StaticResource BorderColorBrush}" BorderThickness="0,0,1,1" CornerRadius="0,0,3,0">
                 <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <!-- KeyboardGrid -->
                    <Grid x:Name="KeyboardGrid" Grid.Column="0" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,0,10,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="30"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="30"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" x:Name="KeyEsc" Content="Es"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="1" x:Name="KeyF1" Content="F1"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="2" x:Name="KeyF2" Content="F2"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="3" x:Name="KeyF3" Content="F3"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="4" x:Name="KeyF4" Content="F4"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="5" x:Name="KeyF5" Content="F5"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="6" x:Name="KeyF6" Content="F6"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="7" x:Name="KeyF7" Content="F7"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="8" x:Name="KeyF8" Content="F8"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="9" x:Name="KeyF9" Content="F9"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="10" x:Name="KeyF10" Content="F10"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="11" x:Name="KeyF11" Content="F11"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="12" x:Name="KeyF12" Content="F12"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="13" x:Name="KeyPrtSc" Content="PS"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="15" x:Name="KeyScrLk" Content="SL"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="12" x:Name="KeyPause" Content="Pa" Grid.Row="4"/>

                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" x:Name="KeyTilde" Content="`"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="1" x:Name="Key1" Content="1"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="2" x:Name="Key2" Content="2"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="3" x:Name="Key3" Content="3"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="4" x:Name="Key4" Content="4"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="5" x:Name="Key5" Content="5"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="6" x:Name="Key6" Content="6"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="7" x:Name="Key7" Content="7"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="8" x:Name="Key8" Content="8"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="9" x:Name="Key9" Content="9"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="10" x:Name="Key0" Content="0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="11" x:Name="KeyMinus" Content="-"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="12" x:Name="KeyEquals" Content="="/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="13" x:Name="KeyBackspace" Content="Bk" HorizontalAlignment="Stretch" Margin="1,0,1,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="15" x:Name="KeyIns" Content="In"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="16" x:Name="KeyHome" Content="Hm"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="17" x:Name="KeyPgUp" Content="PU"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="18" x:Name="KeyNumLock" Content="NL"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="1" Grid.Column="18" x:Name="KeyNumDivide" Content="/"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="18" x:Name="KeyNumMultiply" Content="*"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" x:Name="KeyNumMinus" Content="-"/>

                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" x:Name="KeyTab" Content="Tb" HorizontalAlignment="Stretch" Margin="1,0,1,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="1" x:Name="KeyQ" Content="Q"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="2" x:Name="KeyW" Content="W"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="3" x:Name="KeyE" Content="E"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="4" x:Name="KeyR" Content="R"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="5" x:Name="KeyT" Content="T"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="6" x:Name="KeyY" Content="Y"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="7" x:Name="KeyU" Content="U"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="8" x:Name="KeyI" Content="I"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="9" x:Name="KeyO" Content="O"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="10" x:Name="KeyP" Content="P"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="11" x:Name="KeyLBracket" Content="["/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="12" x:Name="KeyRBracket" Content="]"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="13" x:Name="KeyBackslash" Content="\"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="13" x:Name="KeyDel" Content="Dl" Grid.Row="3"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="16" x:Name="KeyEnd" Content="En"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Column="17" x:Name="KeyPgDn" Content="PD"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="15" x:Name="KeyNum7" Content="7"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="16" x:Name="KeyNum8" Content="8"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="2" Grid.Column="17" x:Name="KeyNum9" Content="9"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="18" x:Name="KeyNumPlus" Content="+" VerticalAlignment="Stretch" Margin="0,1,0,1"/>

                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" x:Name="KeyCaps" Content="CS" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="1" x:Name="KeyA" Content="A"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="2" x:Name="KeyS" Content="S"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="3" x:Name="KeyD" Content="D"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="4" x:Name="KeyF" Content="F"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="5" x:Name="KeyG" Content="G"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="6" x:Name="KeyH" Content="H"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="7" x:Name="KeyJ" Content="J"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="8" x:Name="KeyK" Content="K"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="9" x:Name="KeyL" Content="L"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="10" x:Name="KeySemicolon" Content=";"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="11" x:Name="KeyApostrophe" Content="'"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="12" x:Name="KeyEnter" Content="Ent" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="15" x:Name="KeyNum4" Content="4"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="16" x:Name="KeyNum5" Content="5"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="3" Grid.Column="17" x:Name="KeyNum6" Content="6"/>

                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" x:Name="KeyLShift" Content="Sh" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="1" x:Name="KeyZ" Content="Z"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="2" x:Name="KeyX" Content="X"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="3" x:Name="KeyC" Content="C"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="4" x:Name="KeyV" Content="V"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="5" x:Name="KeyB" Content="B"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="6" x:Name="KeyN" Content="N"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="7" x:Name="KeyM" Content="M"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="8" x:Name="KeyComma" Content=","/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="9" x:Name="KeyPeriod" Content="."/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="10" x:Name="KeySlash" Content="/"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="11" x:Name="KeyRShift" Content="Sh" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="13" x:Name="KeyUpButton" Content="↑"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="15" x:Name="KeyNum1" Content="1"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="16" x:Name="KeyNum2" Content="2"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="4" Grid.Column="17" x:Name="KeyNum3" Content="3"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="18" x:Name="KeyNumEnter" Content="Ent" VerticalAlignment="Stretch" Margin="0,1,0,1"/>

                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" x:Name="KeyLCtrl" Content="Ct" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="1" x:Name="KeyLWin" Content="Wn"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="2" x:Name="KeyLAlt" Content="Al"/>
                        <Button Style="{StaticResource SmallSpacebarStyle}" Grid.Row="5" Grid.Column="3" Grid.ColumnSpan="5" x:Name="KeySpace" Content="" Margin="0,0,2,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="8" x:Name="KeyRAlt" Content="Al"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="9" x:Name="KeyRWin" Content="Wn"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="10" x:Name="KeyMenu" Content="Mn"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="11" x:Name="KeyRCtrl" Content="Ct" HorizontalAlignment="Stretch" Margin="2,0,0,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="12" x:Name="KeyLeft" Content="←"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="13" x:Name="KeyDownButton" Content="↓"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="15" x:Name="KeyRight" Content="→"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="16" x:Name="KeyNum0" Content="0" HorizontalAlignment="Stretch" Margin="1,0,1,0"/>
                        <Button Style="{StaticResource SmallKeyboardButtonStyle}" Grid.Row="5" Grid.Column="17" x:Name="KeyNumDecimal" Content="."/>
                    </Grid>
                    <!-- Mouse Border -->
                    <Border Grid.Column="1" Margin="5,0,0,0" Background="{StaticResource PrimaryBackgroundColor}" BorderBrush="{StaticResource AccentColorBrush}" BorderThickness="1" CornerRadius="3" VerticalAlignment="Center">
                        <Grid HorizontalAlignment="Center" VerticalAlignment="Center" Height="202" Width="187">
                            <Path x:Name="MouseBackgroundOutline"
                                      Data="M70,10 C30,10 10,50 10,105 10,160 30,200 70,200 C110,200 130,160 130,105 C130,50 110,10 70,10 Z"
                                      Fill="{StaticResource TextDisabledColorBrush}"
                                      Stroke="{StaticResource BorderColorBrush}"
                                      StrokeThickness="1.5" Stretch="Fill" Margin="36,1,40,-1"/>
                            <Grid x:Name="MouseButtonsGrid" Width="167" Height="200" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Grid.Resources>
                                </Grid.Resources>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="0.55*"/>
                                    <RowDefinition Height="0.45*"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="0.2*"/>
                                    <ColumnDefinition Width="0.3*"/>
                                    <ColumnDefinition Width="Auto" MinWidth="15"/>
                                    <ColumnDefinition Width="0.3*"/>
                                    <ColumnDefinition Width="0.2*"/>
                                </Grid.ColumnDefinitions>

                                <Button x:Name="MouseLMB" Grid.Row="0" Grid.Column="1" Style="{StaticResource StandardMouseButtonStyle}" ToolTip="Left Mouse Button"/>
                                <Button x:Name="MouseRMB" Grid.Row="0" Grid.Column="3" Style="{StaticResource StandardMouseButtonStyle}" ToolTip="Right Mouse Button"/>

                                <Grid Grid.Row="0" Grid.Column="2" >
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <Button x:Name="MouseScrollUp" Grid.Row="0" Style="{StaticResource ScrollIndicatorButtonStyle}" ToolTip="Scroll Up" VerticalAlignment="Stretch" HorizontalAlignment="Stretch"/>
                                    <Button x:Name="MouseScrollClick" Grid.Row="1" Style="{StaticResource StandardMouseButtonStyle}" ToolTip="Scroll Wheel Click" Width="15" Height="25" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    <Button x:Name="MouseScrollDown" Grid.Row="2" Style="{StaticResource ScrollIndicatorButtonStyle}" ToolTip="Scroll Down" VerticalAlignment="Stretch" HorizontalAlignment="Stretch"/>
                                </Grid>

                                <StackPanel Grid.Row="0" Grid.Column="0" Grid.RowSpan="2" VerticalAlignment="Center" Margin="0,0,5,0">
                                    <Button x:Name="MouseMB4" Content="4" Style="{StaticResource SideMouseButtonSyle}" ToolTip="Mouse Button 4" Margin="0,0,0,5" Width="25" Height="30" Click="MouseMB4_Click"/>
                                    <Button x:Name="MouseMB5" Content="5" Style="{StaticResource SideMouseButtonSyle}" ToolTip="Mouse Button 5" Width="25" Height="30"/>
                                </StackPanel>

                                <Path Grid.Row="0" Grid.Column="1" Data="{StaticResource LMB_OverlayShape}" Fill="{StaticResource MouseLMBColor}" Stretch="Uniform" IsHitTestVisible="False" Margin="0,0,2,0"/>
                                <Path Grid.Row="0" Grid.Column="3" Data="{StaticResource RMB_OverlayShape}" Fill="{StaticResource MouseRMBColor}" Stretch="Uniform" IsHitTestVisible="False" Margin="2,0,0,0"/>
                                <Path Grid.Column="2" Grid.Row="0" Data="{StaticResource ScrollClick_OverlayShape}" Fill="{StaticResource MouseScrollClickColor}" Width="10" Height="20" HorizontalAlignment="Center" VerticalAlignment="Center" Stretch="Fill" IsHitTestVisible="False"/>
                                <Path Grid.Row="0" Grid.Column="2" Data="{StaticResource ScrollUpChevrons}" Stroke="{StaticResource MouseScrollUpColor}" StrokeThickness="2" VerticalAlignment="Top" Margin="0,12,0,0" HorizontalAlignment="Center" IsHitTestVisible="False" Height="14" Width="14" Stretch="Fill"/>
                                <Path Grid.Row="0" Grid.Column="2" Data="{StaticResource ScrollDownChevrons}" Stroke="{StaticResource MouseScrollDownColor}" StrokeThickness="2" VerticalAlignment="Bottom" Margin="0,0,0,10" HorizontalAlignment="Center" IsHitTestVisible="False" Height="14" Width="14" Stretch="Fill"/>
                            </Grid>
                        </Grid>
                    </Border>
                 </Grid>
             </Border>

             <!-- RELOCATED Bottom Buttons -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,5,5">
                <Button x:Name="TestButton" Content="Test" Width="75" Margin="0,0,5,0" Click="TestButton_Click"/>
                <Button x:Name="CancelButton" Content="Cancel" Width="75" Margin="0,0,5,0" Click="CancelButton_Click"/>
                <Button x:Name="OkButton" Content="Ok" Width="75" Margin="0,0,2,0" Click="OkButton_Click"/>
            </StackPanel>
        </Grid>

    </Grid>
</Window>